<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Valentine Adventure - Level 1</title>
  <style>
    body {
      margin: 0;
      background: #202030;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
      font-family: sans-serif;
    }
    #game {
      border: 4px solid #fff;
      image-rendering: pixelated;
      background: #1b2033;
    }
  </style>
</head>
<body>
  <canvas id="game" width="640" height="480"></canvas>

  <script>
    console.log("Game script running");

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const TILE = 32;
    const COLS = canvas.width / TILE;   // 20
    const ROWS = canvas.height / TILE;  // 15

    const TILE_GRASS   = 0;
    const TILE_WATER   = 1;
    const TILE_LILYPAD = 2;
    const TILE_HOUSE   = 3;
    const TILE_LILY    = 4;
    const TILE_TARGET  = 5;

    const map = [];
    for (let y = 0; y < ROWS; y++) {
      map[y] = [];
      for (let x = 0; x < COLS; x++) {
        map[y][x] = TILE_GRASS;
      }
    }

    // Pond area
    for (let y = 7; y <= 11; y++) {
      for (let x = 5; x <= 14; x++) {
        map[y][x] = TILE_WATER;
      }
    }

    // Island
    for (let x = 8; x <= 11; x++) {
      map[8][x]  = TILE_LILYPAD;
      map[9][x]  = TILE_LILYPAD;
      map[10][x] = TILE_LILYPAD;
    }

    // House strip
    map[7][9]  = TILE_HOUSE;
    map[7][10] = TILE_HOUSE;

    // Bridge
    for (let y = 6; y <= 10; y++) {
      map[y][9] = TILE_LILYPAD;
    }

    const wildLilyPositions = [
      [3, 8], [5, 5], [6, 12],
      [15, 6], [16, 10], [13, 13]
    ];
    for (const [x, y] of wildLilyPositions) {
      map[y][x] = TILE_LILY;
    }

    const targetPositions = [
      [8, 9], [9, 9], [10, 9], [11, 9],
      [8, 10], [11, 10]
    ];
    for (const [x, y] of targetPositions) {
      if (map[y][x] === TILE_LILYPAD || map[y][x] === TILE_GRASS) {
        map[y][x] = TILE_TARGET;
      }
    }

    let liliesCollected = 0;
    const totalTargets = targetPositions.length;
    let liliesPlaced = 0;

    const player = { x: 7, y: 10 };

    function insideBounds(nx, ny) {
      return nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS;
    }

    function isWalkable(tile) {
      return (
        tile === TILE_GRASS ||
        tile === TILE_LILYPAD ||
        tile === TILE_LILY ||
        tile === TILE_TARGET
      );
    }

    // Angry Bird NPC
    let birdSpawned = false;
    const bird = { x: 10, y: 11, talking: false };

    function isAdjacentToBird() {
      if (!birdSpawned) return false;
      const dx = Math.abs(player.x - bird.x);
      const dy = Math.abs(player.y - bird.y);
      return dx + dy === 1; // orthogonal neighbor
    }

    function interact() {
      const x = player.x;
      const y = player.y;
      const tile = map[y][x];

      // Talk to bird if adjacent and spawned
      if (birdSpawned && isAdjacentToBird()) {
        bird.talking = !bird.talking; // toggle dialog
        return;
      }

      // If dialog is open and you press interact again, close it
      if (bird.talking) {
        bird.talking = false;
        return;
      }

      // Lilies
      if (tile === TILE_LILY) {
        liliesCollected += 1;
        map[y][x] = TILE_GRASS;
      } else if (tile === TILE_TARGET && liliesCollected > 0) {
        liliesCollected -= 1;
        liliesPlaced += 1;
        map[y][x] = TILE_LILY;
      }

      // Spawn bird when all spots filled
      if (!birdSpawned && liliesPlaced === totalTargets) {
        birdSpawned = true;
      }
    }

    window.addEventListener('keydown', e => {
      if (e.key === ' ' || e.key === 'Enter' || e.key === 'e' || e.key === 'E') {
        interact();
        return;
      }

      let dx = 0, dy = 0;
      if (e.key === 'ArrowLeft' || e.key === 'a')        dx = -1;
      else if (e.key === 'ArrowRight' || e.key === 'd')  dx = 1;
      else if (e.key === 'ArrowUp' || e.key === 'w')     dy = -1;
      else if (e.key === 'ArrowDown' || e.key === 's')   dy = 1;

      if (dx !== 0 || dy !== 0) {
        const nx = player.x + dx;
        const ny = player.y + dy;
        if (insideBounds(nx, ny) && isWalkable(map[ny][nx])) {
          player.x = nx;
          player.y = ny;
        }
      }
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          const tile = map[y][x];
          if (tile === TILE_GRASS) {
            ctx.fillStyle = '#2f9e44';
          } else if (tile === TILE_WATER) {
            ctx.fillStyle = '#1864ab';
          } else if (tile === TILE_LILYPAD) {
            ctx.fillStyle = '#38b000';
          } else if (tile === TILE_HOUSE) {
            ctx.fillStyle = '#d4a373';
          } else if (tile === TILE_LILY) {
            ctx.fillStyle = '#ffb3c6';
          } else if (tile === TILE_TARGET) {
            ctx.fillStyle = '#9ef01a';
          }
          ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
        }
      }

      // Player
      ctx.fillStyle = '#ffd35a';
      ctx.fillRect(player.x * TILE, player.y * TILE, TILE, TILE);

      // Angry Bird NPC
      if (birdSpawned) {
        ctx.fillStyle = '#ff4b4b'; // red bird
        ctx.fillRect(bird.x * TILE, bird.y * TILE, TILE, TILE);
      }

      // HUD
      ctx.fillStyle = '#000000aa';
      ctx.fillRect(0, 0, canvas.width, 50);

      ctx.fillStyle = '#ffffff';
      ctx.font = '14px sans-serif';
      ctx.fillText('Move: WASD / arrows | Interact: E / Space / Enter', 10, 18);
      ctx.fillText(`Lilies in bag: ${liliesCollected} | Spots filled: ${liliesPlaced}/${totalTargets}`, 10, 36);

      if (birdSpawned && isAdjacentToBird() && !bird.talking) {
        ctx.fillText('Press E / Space / Enter to talk to the bird', 10, canvas.height - 10);
      }

      // Bird dialog
      if (bird.talking) {
        const boxWidth = canvas.width - 40;
        const boxHeight = 70;
        const boxX = 20;
        const boxY = canvas.height - boxHeight - 20;

        ctx.fillStyle = '#000000dd';
        ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

        ctx.strokeStyle = '#ffffff';
        ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

        ctx.fillStyle = '#ffffff';
        ctx.font = '14px sans-serif';
        ctx.fillText('Angry Bird: "Those monkeys stole my egg and hid it up in the jungle!"', boxX + 10, boxY + 24);
        ctx.fillText('Angry Bird: "Will you climb up and get it back for me?"', boxX + 10, boxY + 44);
        ctx.fillText('(Press E / Space / Enter to close)', boxX + 10, boxY + 62);
      }
    }

    function loop() {
      draw();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
